<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2E Testing Dashboard - EV Charging Station</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 32px;
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-card h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.pending {
            background: #fef3cd;
            color: #856404;
        }

        .status-badge.running {
            background: #cfe2ff;
            color: #084298;
        }

        .status-badge.passed {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-badge.failed {
            background: #f8d7da;
            color: #842029;
        }

        .test-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s;
        }

        .test-button:hover {
            transform: translateY(-2px);
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .test-results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }

        .test-results pre {
            margin: 0;
            white-space: pre-wrap;
            color: #495057;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .quick-link {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            text-decoration: none;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .quick-link:hover {
            transform: translateY(-3px);
        }

        .quick-link-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .quick-link-title {
            font-weight: 600;
        }

        .log-icon {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .log-icon.success { background: #198754; }
        .log-icon.error { background: #dc3545; }
        .log-icon.warning { background: #ffc107; }
        .log-icon.info { background: #0dcaf0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ E2E Testing Dashboard</h1>
        <p class="subtitle">EV Charging Station - Comprehensive Testing Suite</p>

        <!-- Summary Card -->
        <div class="summary-card">
            <h2>Test Execution Summary</h2>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalTests">0</div>
                    <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="passedTests">0</div>
                    <div class="stat-label">Passed ‚úÖ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="failedTests">0</div>
                    <div class="stat-label">Failed ‚ùå</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="passRate">0%</div>
                    <div class="stat-label">Pass Rate</div>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <h2 style="margin-bottom: 15px;">üîó Quick Access</h2>
        <div class="quick-links">
            <a href="./register.html" target="_blank" class="quick-link">
                <div class="quick-link-icon">üë§</div>
                <div class="quick-link-title">ƒêƒÉng k√Ω Driver</div>
            </a>
            <a href="./login.html" target="_blank" class="quick-link">
                <div class="quick-link-icon">üîë</div>
                <div class="quick-link-title">ƒêƒÉng nh·∫≠p Driver</div>
            </a>
            <a href="./staff/login.html" target="_blank" class="quick-link">
                <div class="quick-link-icon">üëî</div>
                <div class="quick-link-title">Staff Login</div>
            </a>
            <a href="./admin/login.html" target="_blank" class="quick-link">
                <div class="quick-link-icon">‚öôÔ∏è</div>
                <div class="quick-link-title">Admin Login</div>
            </a>
            <a href="./index.html" target="_blank" class="quick-link">
                <div class="quick-link-icon">üó∫Ô∏è</div>
                <div class="quick-link-title">Station Map</div>
            </a>
            <a href="./qr-scanner.html" target="_blank" class="quick-link">
                <div class="quick-link-icon">üì∑</div>
                <div class="quick-link-title">QR Scanner</div>
            </a>
            <a href="./charging-history.html" target="_blank" class="quick-link">
                <div class="quick-link-icon">üìä</div>
                <div class="quick-link-title">L·ªãch s·ª≠ s·∫°c</div>
            </a>
            <a href="./subscription-plans.html" target="_blank" class="quick-link">
                <div class="quick-link-icon">üíé</div>
                <div class="quick-link-title">G√≥i thu√™ bao</div>
            </a>
            <a href="./wallet-topup.html" target="_blank" class="quick-link">
                <div class="quick-link-icon">üí∞</div>
                <div class="quick-link-title">N·∫°p ti·ªÅn</div>
            </a>
        </div>

        <!-- Test Cards -->
        <h2 style="margin-bottom: 15px;">üß™ Automated Tests</h2>
        <div class="test-grid">
            <!-- API Health Check -->
            <div class="test-card">
                <h2>
                    üè• Backend Health Check
                    <span class="status-badge pending" id="status-health">Pending</span>
                </h2>
                <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                    Verify Spring Boot backend is running on port 8080
                </p>
                <button class="test-button" onclick="testBackendHealth()">Run Test</button>
                <div class="test-results" id="results-health" style="display: none;"></div>
            </div>

            <!-- Authentication Test -->
            <div class="test-card">
                <h2>
                    üîê Authentication APIs
                    <span class="status-badge pending" id="status-auth">Pending</span>
                </h2>
                <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                    Test login, register, token refresh, logout
                </p>
                <button class="test-button" onclick="testAuthentication()">Run Test</button>
                <div class="test-results" id="results-auth" style="display: none;"></div>
            </div>

            <!-- Driver APIs Test -->
            <div class="test-card">
                <h2>
                    üöó Driver APIs
                    <span class="status-badge pending" id="status-driver">Pending</span>
                </h2>
                <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                    Profile, wallet, charging history, sessions
                </p>
                <button class="test-button" onclick="testDriverAPIs()">Run Test</button>
                <div class="test-results" id="results-driver" style="display: none;"></div>
            </div>

            <!-- Station APIs Test -->
            <div class="test-card">
                <h2>
                    ‚ö° Station APIs
                    <span class="status-badge pending" id="status-station">Pending</span>
                </h2>
                <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                    Get stations, chargers, nearby search, booking
                </p>
                <button class="test-button" onclick="testStationAPIs()">Run Test</button>
                <div class="test-results" id="results-station" style="display: none;"></div>
            </div>

            <!-- Payment APIs Test -->
            <div class="test-card">
                <h2>
                    üí≥ Payment APIs
                    <span class="status-badge pending" id="status-payment">Pending</span>
                </h2>
                <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                    Wallet top-up, subscription plans, payments
                </p>
                <button class="test-button" onclick="testPaymentAPIs()">Run Test</button>
                <div class="test-results" id="results-payment" style="display: none;"></div>
            </div>

            <!-- Session Persistence Test -->
            <div class="test-card">
                <h2>
                    üíæ Session Persistence
                    <span class="status-badge pending" id="status-session">Pending</span>
                </h2>
                <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                    LocalStorage, token expiry, auto-login
                </p>
                <button class="test-button" onclick="testSessionPersistence()">Run Test</button>
                <div class="test-results" id="results-session" style="display: none;"></div>
            </div>
        </div>

        <!-- Run All Button -->
        <div style="text-align: center; margin: 40px 0;">
            <button class="test-button" style="max-width: 400px; padding: 18px; font-size: 16px;" onclick="runAllTests()">
                üöÄ Run All Tests
            </button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };

        function updateSummary() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            const passRate = testResults.total > 0 
                ? Math.round((testResults.passed / testResults.total) * 100) 
                : 0;
            document.getElementById('passRate').textContent = passRate + '%';
        }

        function logResult(testId, message, type = 'info') {
            const resultsDiv = document.getElementById(`results-${testId}`);
            resultsDiv.style.display = 'block';
            const icon = `<span class="log-icon ${type}"></span>`;
            resultsDiv.innerHTML += `${icon}${message}\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function setStatus(testId, status) {
            const badge = document.getElementById(`status-${testId}`);
            badge.className = `status-badge ${status}`;
            badge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }

        async function testBackendHealth() {
            const testId = 'health';
            setStatus(testId, 'running');
            document.getElementById(`results-${testId}`).innerHTML = '';
            
            try {
                logResult(testId, 'üîç Checking backend at ' + API_BASE, 'info');
                
                const response = await fetch(API_BASE + '/test/hello');
                logResult(testId, `Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.text();
                    logResult(testId, `Response: ${data}`, 'success');
                    logResult(testId, '‚úÖ Backend is healthy!', 'success');
                    setStatus(testId, 'passed');
                    testResults.passed++;
                } else {
                    logResult(testId, '‚ùå Backend returned error', 'error');
                    setStatus(testId, 'failed');
                    testResults.failed++;
                }
            } catch (error) {
                logResult(testId, `‚ùå Error: ${error.message}`, 'error');
                logResult(testId, '‚ö†Ô∏è Make sure backend is running!', 'warning');
                setStatus(testId, 'failed');
                testResults.failed++;
            }
            
            testResults.total++;
            updateSummary();
        }

        async function testAuthentication() {
            const testId = 'auth';
            setStatus(testId, 'running');
            document.getElementById(`results-${testId}`).innerHTML = '';
            
            try {
                logResult(testId, 'üîê Testing authentication flow', 'info');
                
                // Test login
                logResult(testId, '1. Testing login...', 'info');
                const loginResponse = await fetch(API_BASE + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'Test@123'
                    })
                });
                
                if (loginResponse.ok) {
                    const loginData = await loginResponse.json();
                    logResult(testId, '‚úÖ Login successful', 'success');
                    logResult(testId, `Token: ${loginData.accessToken?.substring(0, 20)}...`, 'info');
                } else {
                    logResult(testId, '‚ö†Ô∏è Login failed (expected if no test user)', 'warning');
                }
                
                // Test registration endpoint exists
                logResult(testId, '2. Testing registration endpoint...', 'info');
                const registerResponse = await fetch(API_BASE + '/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'newuser@test.com',
                        password: 'Test@123',
                        name: 'Test User'
                    })
                });
                
                logResult(testId, `Registration endpoint status: ${registerResponse.status}`, 'info');
                
                logResult(testId, '‚úÖ Authentication tests completed', 'success');
                setStatus(testId, 'passed');
                testResults.passed++;
                
            } catch (error) {
                logResult(testId, `‚ùå Error: ${error.message}`, 'error');
                setStatus(testId, 'failed');
                testResults.failed++;
            }
            
            testResults.total++;
            updateSummary();
        }

        async function testDriverAPIs() {
            const testId = 'driver';
            setStatus(testId, 'running');
            document.getElementById(`results-${testId}`).innerHTML = '';
            
            try {
                logResult(testId, 'üöó Testing Driver APIs', 'info');
                
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    logResult(testId, '‚ö†Ô∏è No token found. Please login first.', 'warning');
                    logResult(testId, '‚úì Using mock token for testing', 'info');
                }
                
                // Test profile endpoint
                logResult(testId, '1. Testing /driver/profile...', 'info');
                const profileResponse = await fetch(API_BASE + '/driver/profile', {
                    headers: { 'Authorization': `Bearer ${token || 'mock-token'}` }
                });
                logResult(testId, `Profile endpoint: ${profileResponse.status}`, 
                    profileResponse.ok ? 'success' : 'warning');
                
                // Test wallet endpoint
                logResult(testId, '2. Testing /driver/wallet...', 'info');
                const walletResponse = await fetch(API_BASE + '/driver/wallet', {
                    headers: { 'Authorization': `Bearer ${token || 'mock-token'}` }
                });
                logResult(testId, `Wallet endpoint: ${walletResponse.status}`, 
                    walletResponse.ok ? 'success' : 'warning');
                
                // Test charging history
                logResult(testId, '3. Testing /driver/charging-history...', 'info');
                const historyResponse = await fetch(API_BASE + '/driver/charging-history', {
                    headers: { 'Authorization': `Bearer ${token || 'mock-token'}` }
                });
                logResult(testId, `History endpoint: ${historyResponse.status}`, 
                    historyResponse.ok ? 'success' : 'warning');
                
                logResult(testId, '‚úÖ Driver API tests completed', 'success');
                setStatus(testId, 'passed');
                testResults.passed++;
                
            } catch (error) {
                logResult(testId, `‚ùå Error: ${error.message}`, 'error');
                setStatus(testId, 'failed');
                testResults.failed++;
            }
            
            testResults.total++;
            updateSummary();
        }

        async function testStationAPIs() {
            const testId = 'station';
            setStatus(testId, 'running');
            document.getElementById(`results-${testId}`).innerHTML = '';
            
            try {
                logResult(testId, '‚ö° Testing Station APIs', 'info');
                
                // Test get all stations
                logResult(testId, '1. Testing GET /stations...', 'info');
                const stationsResponse = await fetch(API_BASE + '/stations');
                logResult(testId, `Status: ${stationsResponse.status}`, 
                    stationsResponse.ok ? 'success' : 'error');
                
                if (stationsResponse.ok) {
                    const stations = await stationsResponse.json();
                    logResult(testId, `‚úÖ Found ${stations.length || 0} stations`, 'success');
                }
                
                // Test nearby search
                logResult(testId, '2. Testing nearby search...', 'info');
                const nearbyResponse = await fetch(API_BASE + '/stations/nearby?lat=10.762622&lng=106.660172');
                logResult(testId, `Nearby endpoint: ${nearbyResponse.status}`, 
                    nearbyResponse.ok ? 'success' : 'warning');
                
                logResult(testId, '‚úÖ Station API tests completed', 'success');
                setStatus(testId, 'passed');
                testResults.passed++;
                
            } catch (error) {
                logResult(testId, `‚ùå Error: ${error.message}`, 'error');
                setStatus(testId, 'failed');
                testResults.failed++;
            }
            
            testResults.total++;
            updateSummary();
        }

        async function testPaymentAPIs() {
            const testId = 'payment';
            setStatus(testId, 'running');
            document.getElementById(`results-${testId}`).innerHTML = '';
            
            try {
                logResult(testId, 'üí≥ Testing Payment APIs', 'info');
                
                const token = localStorage.getItem('accessToken');
                
                // Test payment methods
                logResult(testId, '1. Testing GET /payment/methods...', 'info');
                const methodsResponse = await fetch(API_BASE + '/payment/methods');
                logResult(testId, `Status: ${methodsResponse.status}`, 
                    methodsResponse.ok ? 'success' : 'warning');
                
                // Test subscription plans
                logResult(testId, '2. Testing GET /admin/subscriptions...', 'info');
                const plansResponse = await fetch(API_BASE + '/admin/subscriptions', {
                    headers: { 'Authorization': `Bearer ${token || 'mock-token'}` }
                });
                logResult(testId, `Plans endpoint: ${plansResponse.status}`, 
                    plansResponse.ok ? 'success' : 'warning');
                
                logResult(testId, '‚úÖ Payment API tests completed', 'success');
                setStatus(testId, 'passed');
                testResults.passed++;
                
            } catch (error) {
                logResult(testId, `‚ùå Error: ${error.message}`, 'error');
                setStatus(testId, 'failed');
                testResults.failed++;
            }
            
            testResults.total++;
            updateSummary();
        }

        async function testSessionPersistence() {
            const testId = 'session';
            setStatus(testId, 'running');
            document.getElementById(`results-${testId}`).innerHTML = '';
            
            try {
                logResult(testId, 'üíæ Testing Session Persistence', 'info');
                
                // Check localStorage
                logResult(testId, '1. Checking localStorage...', 'info');
                const token = localStorage.getItem('accessToken');
                const userId = localStorage.getItem('userId');
                const userRole = localStorage.getItem('userRole');
                
                if (token) {
                    logResult(testId, '‚úÖ Token found in localStorage', 'success');
                    logResult(testId, `User ID: ${userId || 'N/A'}`, 'info');
                    logResult(testId, `Role: ${userRole || 'N/A'}`, 'info');
                } else {
                    logResult(testId, '‚ö†Ô∏è No token in localStorage (login required)', 'warning');
                }
                
                // Test token format
                logResult(testId, '2. Validating token format...', 'info');
                if (token && token.split('.').length === 3) {
                    logResult(testId, '‚úÖ JWT format valid', 'success');
                } else if (token) {
                    logResult(testId, '‚ö†Ô∏è Token format invalid', 'warning');
                }
                
                // Test session data
                logResult(testId, '3. Checking session data structure...', 'info');
                const sessionKeys = ['accessToken', 'refreshToken', 'userId', 'userRole', 'userName'];
                sessionKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    logResult(testId, `${key}: ${value ? '‚úì' : '‚úó'}`, value ? 'success' : 'warning');
                });
                
                logResult(testId, '‚úÖ Session persistence tests completed', 'success');
                setStatus(testId, 'passed');
                testResults.passed++;
                
            } catch (error) {
                logResult(testId, `‚ùå Error: ${error.message}`, 'error');
                setStatus(testId, 'failed');
                testResults.failed++;
            }
            
            testResults.total++;
            updateSummary();
        }

        async function runAllTests() {
            testResults = { total: 0, passed: 0, failed: 0 };
            updateSummary();
            
            await testBackendHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testAuthentication();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDriverAPIs();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testStationAPIs();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testPaymentAPIs();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testSessionPersistence();
            
            alert(`Testing Complete!\nPassed: ${testResults.passed}/${testResults.total}\nFailed: ${testResults.failed}`);
        }

        // Auto-run backend health check on load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                testBackendHealth();
            }, 1000);
        });
    </script>
</body>
</html>
